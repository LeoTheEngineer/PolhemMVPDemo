# 03 - Database Setup

## Purpose

Execute SQL scripts in the correct order to create all database tables in Supabase.

---

## Prerequisites

- `02-environment-setup.md` completed
- Supabase project created
- Access to Supabase SQL Editor (Dashboard → SQL Editor)

---

## SQL Files Location

All SQL files are in the `sql/` folder:

```
sql/
├── drop-tables.sql      # Reset database (optional, for fresh start)
├── create-tables.sql    # Create all tables with constraints
├── seed-data.sql        # Populate demo data
└── functions.sql        # PostgreSQL functions (optional)
```

---

## Execution Order

Execute these SQL scripts **in order** via Supabase SQL Editor:

| Order | File | Purpose | When to Run |
|-------|------|---------|-------------|
| 1 | `drop-tables.sql` | Drop all existing tables | Only if resetting |
| 2 | `create-tables.sql` | Create schema | Always |
| 3 | `seed-data.sql` | Insert demo data | After tables created |
| 4 | `functions.sql` | Create helper functions | Optional |

---

## Implementation

### Step 1: Open Supabase SQL Editor

1. Go to [Supabase Dashboard](https://supabase.com/dashboard)
2. Select your project
3. Click **SQL Editor** in the left sidebar
4. Click **+ New query**

---

### Step 2: Drop Existing Tables (Optional)

**Only run this if you want a fresh start or are resetting the database.**

Copy the contents of `sql/drop-tables.sql` and execute:

```sql
-- Drop all tables, types, and triggers for Polhem MVP
-- Run this to completely reset the database

-- Drop triggers first
DROP TRIGGER IF EXISTS update_customers_updated_at ON customers;
DROP TRIGGER IF EXISTS update_products_updated_at ON products;
DROP TRIGGER IF EXISTS update_settings_updated_at ON settings;
DROP TRIGGER IF EXISTS update_production_blocks_updated_at ON production_blocks;

-- Drop function
DROP FUNCTION IF EXISTS update_updated_at_column();

-- Drop tables (in order respecting foreign keys)
DROP TABLE IF EXISTS production_blocks CASCADE;
DROP TABLE IF EXISTS predicted_orders CASCADE;
DROP TABLE IF EXISTS product_forecasts CASCADE;
DROP TABLE IF EXISTS orders CASCADE;
DROP TABLE IF EXISTS products CASCADE;
DROP TABLE IF EXISTS machines CASCADE;
DROP TABLE IF EXISTS materials CASCADE;
DROP TABLE IF EXISTS customers CASCADE;
DROP TABLE IF EXISTS settings CASCADE;

-- Drop custom types
DROP TYPE IF EXISTS order_interval_enum CASCADE;
DROP TYPE IF EXISTS order_status_enum CASCADE;
```

Click **Run** to execute.

---

### Step 3: Create Tables

Copy the contents of `sql/create-tables.sql` and execute. This creates:

- Custom enum types (`order_interval_enum`, `order_status_enum`)
- All 9 tables with proper constraints
- Indexes for performance
- Triggers for `updated_at` columns

**Key tables created:**

| Table | Purpose |
|-------|---------|
| `customers` | Customer companies |
| `materials` | Plastic materials (ABS, PP, etc.) |
| `machines` | Injection molding machines |
| `products` | Products with manufacturing specs |
| `orders` | Real customer orders |
| `product_forecasts` | Customer-provided forecasts |
| `predicted_orders` | System-generated predictions |
| `production_blocks` | Scheduled production runs |
| `settings` | Application settings (single row, id='main') |

Click **Run** to execute.

---

### Step 4: Seed Demo Data

Copy the contents of `sql/seed-data.sql` and execute. This inserts:

- 4 customers (Volvo, Scania, Electrolux, IKEA)
- 5 materials (ABS, PP, HDPE, PA, PC)
- 10 machines with varying capabilities
- ~16 products across customers
- ~150 historical orders
- Default settings row

Click **Run** to execute.

---

### Step 5: Verify Data

Run these verification queries to confirm data was inserted:

```sql
-- Count rows in each table
SELECT 
  'customers' as table_name, COUNT(*) as row_count FROM customers
UNION ALL SELECT 'materials', COUNT(*) FROM materials
UNION ALL SELECT 'machines', COUNT(*) FROM machines
UNION ALL SELECT 'products', COUNT(*) FROM products
UNION ALL SELECT 'orders', COUNT(*) FROM orders
UNION ALL SELECT 'product_forecasts', COUNT(*) FROM product_forecasts
UNION ALL SELECT 'predicted_orders', COUNT(*) FROM predicted_orders
UNION ALL SELECT 'production_blocks', COUNT(*) FROM production_blocks
UNION ALL SELECT 'settings', COUNT(*) FROM settings;
```

**Expected results:**

| table_name | row_count |
|------------|-----------|
| customers | 4 |
| materials | 5 |
| machines | 10 |
| products | ~16 |
| orders | ~150 |
| product_forecasts | ~16 |
| predicted_orders | 0 (will be added in next step) |
| production_blocks | 0 (generated by app) |
| settings | 1 |

---

### Step 6: Verify Settings Row

Confirm the settings monolith row exists:

```sql
SELECT * FROM settings WHERE id = 'main';
```

Should return one row with default values.

---

### Step 7: Verify Foreign Key Relationships

Test that relationships work correctly:

```sql
-- Products with their customers and materials
SELECT 
  p.name as product,
  c.name as customer,
  m.name as material
FROM products p
JOIN customers c ON p.customer_id = c.id
JOIN materials m ON p.material_id = m.id
LIMIT 5;
```

Should return 5 rows with valid customer and material names.

---

## Database Schema Overview

```
┌─────────────┐
│  materials  │◄─────────────────────────────────┐
└─────────────┘                                  │ FK (material_id)
                                                 │
┌─────────────┐     1:N     ┌─────────────┐──────┘
│  customers  │────────────►│  products   │
└──────┬──────┘             └──────┬──────┘
       │                           │
       │ 1:N                       │ 1:N
       │         ┌─────────────────┼─────────────────┐
       │         │                 │                 │
       ▼         ▼                 ▼                 ▼
┌─────────────┐ ┌─────────────────┐ ┌───────────────┐ ┌───────────────────┐
│   orders    │ │product_forecasts│ │predicted      │ │ production_blocks │
└─────────────┘ └─────────────────┘ │_orders        │ └───────────────────┘
                                    └───────────────┘          │
                                                               │
                                    ┌─────────────┐            │
                                    │  machines   │◄───────────┘
                                    └─────────────┘

┌─────────────┐
│  settings   │  (single row, id='main')
└─────────────┘
```

---

## Troubleshooting

### "relation already exists" error

Run `drop-tables.sql` first to clean up, then run `create-tables.sql` again.

### "violates foreign key constraint" error

Ensure you run scripts in the correct order:
1. `create-tables.sql` first
2. `seed-data.sql` second

### Settings row missing

Insert manually:
```sql
INSERT INTO settings (id) VALUES ('main')
ON CONFLICT (id) DO NOTHING;
```

---

## Verification Checklist

- [ ] All 9 tables created
- [ ] Customers table has 4 rows
- [ ] Materials table has 5 rows
- [ ] Machines table has 10 rows
- [ ] Products table has ~16 rows
- [ ] Orders table has ~150 rows
- [ ] Settings table has 1 row with id='main'
- [ ] Foreign key relationships work (products → customers, materials)

---

## Next Step

Proceed to `04-seed-data-updates.md` to add predicted_orders and forecasts data.
